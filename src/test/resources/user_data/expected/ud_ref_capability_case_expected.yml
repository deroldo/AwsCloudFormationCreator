---
Resources:
  MyApp-Vpc:
    Type: "AWS::EC2::VPC"
    Properties:
      EnableDnsSupport: "true"
      EnableDnsHostnames: "true"
      Tags:
      - Key: "Name"
        Value:
          Fn::Join:
          - "-"
          - - "my-env"
            - "VPC"
      CidrBlock: "10.1.0.0/16"
  MyApp-EcsInstanceRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "EcsRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service: "ec2.amazonaws.com"
          Action: "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
      - "arn:aws:iam::aws:policy/AmazonRDSFullAccess"
      - "arn:aws:iam::aws:policy/AmazonSQSFullAccess"
      - "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
  MyApp-SSHLocalRolePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "EcsPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Action:
          - "iam:ListUsers"
          - "iam:GetGroup"
          Resource: "*"
        - Effect: "Allow"
          Action:
          - "iam:ListSSHPublicKeys"
          - "iam:GetSSHPublicKey"
          Resource:
            Fn::Sub: "arn:aws:iam::${AWS::AccountId}:user/*"
        - Effect: "Allow"
          Action: "ec2:DescribeTags"
          Resource: "*"
      Roles:
      - Ref: "MyApp-EcsInstanceRole"
  MyApp-EcsInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      InstanceProfileName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "EcsProfile"
      Roles:
      - Ref: "MyApp-EcsInstanceRole"
  MyApp-EcsCluster:
    Type: "AWS::ECS::Cluster"
    Properties:
      ClusterName: "my-env"
  MyApp-PubSubnetAz1:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId:
        Ref: "MyApp-Vpc"
      AvailabilityZone:
        Fn::Select:
        - 0
        - - "us-east-1a"
          - "us-east-1c"
      MapPublicIpOnLaunch: true
      CidrBlock: "10.1.0.0/24"
  MyApp-PrivSubnetAz2:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId:
        Ref: "MyApp-Vpc"
      AvailabilityZone:
        Fn::Select:
        - 0
        - - "us-east-1a"
          - "us-east-1c"
      MapPublicIpOnLaunch: false
      CidrBlock: "10.1.1.0/24"
  MyApp-PubSubnetAz3:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId:
        Ref: "MyApp-Vpc"
      AvailabilityZone:
        Fn::Select:
        - 1
        - - "us-east-1a"
          - "us-east-1c"
      MapPublicIpOnLaunch: true
      CidrBlock: "10.1.2.0/24"
  MyApp-PrivSubnetAz4:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId:
        Ref: "MyApp-Vpc"
      AvailabilityZone:
        Fn::Select:
        - 1
        - - "us-east-1a"
          - "us-east-1c"
      MapPublicIpOnLaunch: false
      CidrBlock: "10.1.3.0/24"
  MyApp-InternetGateway:
    Type: "AWS::EC2::InternetGateway"
  MyApp-AttachGateway:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId:
        Ref: "MyApp-Vpc"
      InternetGatewayId:
        Ref: "MyApp-InternetGateway"
  MyApp-RouteViaIgw:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: "MyApp-Vpc"
  MyApp-PublicRouteViaIgw:
    Type: "AWS::EC2::Route"
    DependsOn: "MyApp-AttachGateway"
    Properties:
      RouteTableId:
        Ref: "MyApp-RouteViaIgw"
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId:
        Ref: "MyApp-InternetGateway"
  MyApp-PubSubnet1RouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: "MyApp-PubSubnetAz1"
      RouteTableId:
        Ref: "MyApp-RouteViaIgw"
  MyApp-PrivSubnet2RouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: "MyApp-PrivSubnetAz2"
      RouteTableId:
        Ref: "MyApp-RouteViaIgw"
  MyApp-PubSubnet3RouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: "MyApp-PubSubnetAz3"
      RouteTableId:
        Ref: "MyApp-RouteViaIgw"
  MyApp-PrivSubnet4RouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: "MyApp-PrivSubnetAz4"
      RouteTableId:
        Ref: "MyApp-RouteViaIgw"
  MyApp-EcsInstanceLc:
    Type: "AWS::AutoScaling::LaunchConfiguration"
    Properties:
      AssociatePublicIpAddress: true
      IamInstanceProfile:
        Ref: "MyApp-EcsInstanceProfile"
      KeyName:
        Fn::If:
        - "MyApp-CreateEC2LCWithKeyPair"
        - ""
        - Ref: "AWS::NoValue"
      SecurityGroups:
        Fn::If:
        - "MyApp-ShouldOpenSSH"
        - - Ref: "MyApp-SgDefault"
          - Ref: "MyApp-SgSsh"
        - - Ref: "MyApp-SgDefault"
      BlockDeviceMappings:
        Fn::If:
        - "MyApp-CreateEbsVolume"
        - - DeviceName:
              Fn::Join:
              - "-"
              - - "my-env"
                - "volume"
            Ebs:
              VolumeType: ""
              VolumeSize: 0
        - Ref: "AWS::NoValue"
      UserData:
        Fn::Base64: "#!/bin/bash\necho ECS_CLUSTER=my-env >> /etc/ecs/ecs.config\n"
      ImageId: "ami-83af8395"
      InstanceType: "t2.micro"
  MyApp-EcsInstanceAsg:
    Type: "AWS::AutoScaling::AutoScalingGroup"
    Properties:
      VPCZoneIdentifier:
      - Fn::Sub: "${MyApp-PubSubnetAz1}, ${MyApp-PrivSubnetAz2}, ${MyApp-PubSubnetAz3},\
          \ ${MyApp-PrivSubnetAz4}"
      LaunchConfigurationName:
        Ref: "MyApp-EcsInstanceLc"
      MinSize: "0"
      Tags:
      - Key: "Name"
        Value:
          Fn::Join:
          - "-"
          - - "my-env"
            - "ECS"
        PropagateAtLaunch: "true"
      - Key: "Description"
        Value: "This instance was auto created by the cluster where it is running"
        PropagateAtLaunch: "true"
      MaxSize: 1
      DesiredCapacity: 1
  MyApp-SgDefault:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "Default"
      GroupDescription: "Default SecurityGroup"
      VpcId:
        Ref: "MyApp-Vpc"
  MyApp-SgHttp:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "HTTP"
      GroupDescription: "SecurityGroup HTTP"
      VpcId:
        Ref: "MyApp-Vpc"
  MyApp-SgHttps:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "HTTPS"
      GroupDescription: "SecurityGroup HTTPS"
      VpcId:
        Ref: "MyApp-Vpc"
  MyApp-SgSsh:
    Condition: "MyApp-ShouldOpenSSH"
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName:
        Fn::Join:
        - "-"
        - - "my-env"
          - "SSH"
      GroupDescription: "SecurityGroup SSH"
      VpcId:
        Ref: "MyApp-Vpc"
  MyApp-SgDefaultIngress:
    Type: "AWS::EC2::SecurityGroupIngress"
    Properties:
      GroupId:
        Ref: "MyApp-SgDefault"
      IpProtocol: "-1"
      FromPort: "-1"
      ToPort: "-1"
      SourceSecurityGroupId:
        Ref: "MyApp-SgDefault"
  MyApp-SgHttpIngress:
    Type: "AWS::EC2::SecurityGroupIngress"
    Properties:
      GroupId:
        Ref: "MyApp-SgHttp"
      IpProtocol: "tcp"
      FromPort: "80"
      ToPort: "80"
      CidrIp: "0.0.0.0/0"
  MyApp-SgHttpsIngress:
    Type: "AWS::EC2::SecurityGroupIngress"
    Properties:
      GroupId:
        Ref: "MyApp-SgHttps"
      IpProtocol: "tcp"
      FromPort: "443"
      ToPort: "443"
      CidrIp: "0.0.0.0/0"
  MyApp-SgSshIngress:
    Condition: "MyApp-ShouldOpenSSH"
    Type: "AWS::EC2::SecurityGroupIngress"
    Properties:
      GroupId:
        Ref: "MyApp-SgSsh"
      IpProtocol: "tcp"
      FromPort: "22"
      ToPort: "22"
      CidrIp:
        Fn::Join:
        - ""
        - - "192.168.0.1"
          - "/32"
  MyApp-LoadBalancer:
    Type: "AWS::ElasticLoadBalancingV2::LoadBalancer"
    Properties:
      Name:
        Fn::Join:
        - "-"
        - - "my-env"
          - "ALB"
      Scheme: "internet-facing"
      Subnets:
      - Ref: "MyApp-PubSubnetAz1"
      - Ref: "MyApp-PubSubnetAz3"
      LoadBalancerAttributes:
      - Key: "idle_timeout.timeout_seconds"
        Value: "60"
      SecurityGroups:
      - Ref: "MyApp-SgDefault"
      - Ref: "MyApp-SgHttp"
      - Ref: "MyApp-SgHttps"
  MyApp-HttpListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      DefaultActions:
      - Type: "forward"
        TargetGroupArn:
          Ref: "MyApp-TargetGroup"
      LoadBalancerArn:
        Ref: "MyApp-LoadBalancer"
      Port: "80"
      Protocol: "HTTP"
  MyApp-HttpsListener:
    Condition: "MyApp-CreateHTTPSThings"
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      DefaultActions:
      - Type: "forward"
        TargetGroupArn:
          Ref: "MyApp-TargetGroup"
      LoadBalancerArn:
        Ref: "MyApp-LoadBalancer"
      Port: "443"
      Protocol: "HTTPS"
      Certificates:
      - Ref: "MyApp-CertificateHttp"
  MyApp-TargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: "/"
      HealthCheckPort: "80"
      HealthCheckProtocol: "HTTP"
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 5
      Matcher:
        HttpCode: "200"
      Name:
        Fn::Join:
        - "-"
        - - "my-env"
          - "TG"
      Port: 80
      Protocol: "HTTP"
      UnhealthyThresholdCount: 4
      TargetGroupAttributes:
      - Key: "deregistration_delay.timeout_seconds"
        Value: "20"
      VpcId:
        Ref: "MyApp-Vpc"
      Tags:
      - Key: "Environment"
        Value: "my-env"
  MyApp-CertificateHttp:
    Condition: "MyApp-CreateHTTPSThings"
    Type: "AWS::CertificateManager::Certificate"
    Properties:
      DomainName:
        Fn::If:
        - "MyApp-ShouldUseEnvironmentOnHost"
        - Fn::Join:
          - "."
          - - "my-env"
            - "test.com"
        - "test.com"
      DomainValidationOptions:
      - DomainName:
          Fn::If:
          - "MyApp-ShouldUseEnvironmentOnHost"
          - Fn::Join:
            - "."
            - - "my-env"
              - "test.com"
          - "test.com"
        ValidationDomain:
          Fn::If:
          - "MyApp-ShouldUseEnvironmentOnHost"
          - Fn::Join:
            - "."
            - - "my-env"
              - "test.com"
          - "test.com"
  MyApp-CertificateDistribution:
    Condition: "MyApp-CreateHTTPSThings"
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        ViewerCertificate:
          AcmCertificateArn:
            Ref: "MyApp-CertificateHttp"
          SslSupportMethod: "sni-only"
        Aliases: "test.com"
  MyApp-DBSubnet:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: "Subnet to database"
      SubnetIds:
      - Ref: "MyApp-PubSubnetAz1"
      - Ref: "MyApp-PrivSubnetAz2"
      - Ref: "MyApp-PubSubnetAz3"
      - Ref: "MyApp-PrivSubnetAz4"
      Tags:
      - Key: "Name"
        Value:
          Fn::Join:
          - "-"
          - - "my-env"
            - "DB"
            - "Subnet"
  MyApp-DNSPublico:
    Type: "AWS::Route53::HostedZone"
    Properties:
      HostedZoneConfig:
        Comment: "Hosted zone publico"
      Name:
        Fn::If:
        - "MyApp-ShouldUseEnvironmentOnHost"
        - Fn::Join:
          - "."
          - - "my-env"
            - "test.com"
        - "test.com"
      HostedZoneTags:
      - Key: "Environment"
        Value: "my-env"
  MyApp-DNSPrivado:
    Type: "AWS::Route53::HostedZone"
    Properties:
      HostedZoneConfig:
        Comment: "Hosted zone privado"
      Name:
        Fn::If:
        - "MyApp-ShouldUseEnvironmentOnHost"
        - Fn::Join:
          - "."
          - - "internal"
            - "my-env"
            - "test.com"
        - Fn::Join:
          - "."
          - - "internal"
            - "test.com"
      VPCs:
      - VPCId:
          Ref: "MyApp-Vpc"
        VPCRegion:
          Ref: "AWS::Region"
      HostedZoneTags:
      - Key: "Environment"
        Value: "my-env"
  MyApp-DNSRecordAlbPublico:
    Type: "AWS::Route53::RecordSet"
    DependsOn: "MyApp-LoadBalancer"
    Properties:
      HostedZoneId:
        Ref: "MyApp-DNSPublico"
      Comment: "DNS publico para uso das applications"
      Name:
        Fn::If:
        - "MyApp-ShouldUseEnvironmentOnHost"
        - Fn::Join:
          - "."
          - - "alb"
            - "my-env"
            - "test.com"
        - Fn::Join:
          - "."
          - - "alb"
            - "test.com"
      Type: "A"
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - "MyApp-LoadBalancer"
          - "DNSName"
        EvaluateTargetHealth: false
        HostedZoneId:
          Fn::GetAtt:
          - "MyApp-LoadBalancer"
          - "CanonicalHostedZoneID"
  MyApp-DNSRecordAlbPrivado:
    Type: "AWS::Route53::RecordSet"
    DependsOn: "MyApp-LoadBalancer"
    Properties:
      HostedZoneId:
        Ref: "MyApp-DNSPrivado"
      Comment: "DNS privado para uso das applications"
      Name:
        Fn::If:
        - "MyApp-ShouldUseEnvironmentOnHost"
        - Fn::Join:
          - "."
          - - "alb"
            - "internal"
            - "my-env"
            - "test.com"
        - Fn::Join:
          - "."
          - - "alb"
            - "internal"
            - "test.com"
      Type: "A"
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - "MyApp-LoadBalancer"
          - "DNSName"
        EvaluateTargetHealth: false
        HostedZoneId:
          Fn::GetAtt:
          - "MyApp-LoadBalancer"
          - "CanonicalHostedZoneID"
  MyApp-Email:
    Type: "AWS::Route53::RecordSet"
    Condition: "MyApp-HasMx"
    Properties:
      HostedZoneId:
        Ref: "MyApp-DNSPublico"
      Comment: "Email MX configuration"
      Name:
        Fn::If:
        - "MyApp-ShouldUseEnvironmentOnHost"
        - Fn::Join:
          - "."
          - - "my-env"
            - "test.com"
        - "test.com"
      Type: "MX"
      TTL: "900"
      ResourceRecords:
      - ""
  MyApp-MysqlParameterGroup:
    Type: "AWS::RDS::DBParameterGroup"
    Properties:
      Description: "CloudFormation Parameter Group for MySql - lower case para mysql,\
        \ utf8 e innodb large"
      Family: "mysql5.6"
      Parameters:
        lower_case_table_names: "1"
        character_set_server: "utf8"
        innodb_large_prefix: "1"
      Tags:
      - Key: "Name"
        Value:
          Fn::Join:
          - "-"
          - - "my-env"
            - "lctn"
      - Key: "Environment"
        Value: "my-env"
Outputs:
  MyApp-EcsInstanceAsgName:
    Description: "Auto Scaling Group Name for ECS Instances"
    Value:
      Ref: "MyApp-EcsInstanceAsg"
  MyApp-SecuritiesGroups:
    Description: "Securities groups"
    Value:
      Fn::If:
      - "MyApp-ShouldOpenSSH"
      - "SgDefault,SgHttp,SgHttps,SgSsh"
      - "SgDefault,SgHttp,SgHttps"
  MyApp-Domain:
    Description: "Environment domain"
    Value:
      Fn::If:
      - "MyApp-ShouldUseEnvironmentOnHost"
      - Fn::Join:
        - "."
        - - "my-env"
          - "test.com"
      - "test.com"
Conditions:
  MyApp-CreateEC2LCWithKeyPair:
    Fn::Not:
    - Fn::Equals:
      - ""
      - ""
  MyApp-CreateEbsVolume:
    Fn::And:
    - Fn::Not:
      - Fn::Equals:
        - 0
        - 0
    - Fn::Not:
      - Fn::Equals:
        - ""
        - ""
  MyApp-CreateHTTPSThings:
    Fn::Equals:
    - "false"
    - "true"
  MyApp-ShouldOpenSSH:
    Fn::Not:
    - Fn::Equals:
      - "192.168.0.1"
      - ""
  MyApp-ShouldUseEnvironmentOnHost:
    Fn::Equals:
    - "true"
    - "true"
  MyApp-HasMx:
    Fn::Not:
    - Fn::Equals:
      - Fn::Join:
        - ""
        - - ""
      - ""

